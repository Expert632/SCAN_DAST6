name: DAST ZAP Scan - Always Green

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  dast:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Start app to scan
        run: |
          # Si un Dockerfile existe, on démarre l'app dans un conteneur
          if [ -f Dockerfile ]; then
            echo "Dockerfile trouvé -> build et run sur le port 3000"
            docker build -t dast-lab-app .
            docker run -d --name dast-lab-app -p 3000:3000 dast-lab-app || true

            # attente que le port 3000 soit prêt (max 60s)
            for i in $(seq 1 30); do
              if nc -z localhost 3000; then
                echo "Port 3000 prêt"
                break
              fi
              echo "En attente de l'app sur le port 3000..."
              sleep 2
            done
          else
            echo "Aucun Dockerfile -> on sert le repo en statique sur le port 3000 (python http.server)"
            (python3 -m http.server 3000 &>/tmp/http-server.log &) 
            # simple attente
            for i in $(seq 1 30); do
              if nc -z localhost 3000; then
                echo "Serveur statique prêt sur le port 3000"
                break
              fi
              echo "En attente du serveur statique..."
              sleep 2
            done
          fi

      - name: Check listening ports (debug)
        run: ss -tuln || true

      - name: Run OWASP ZAP Baseline Scan
        id: zap_scan
        uses: zaproxy/action-baseline@v0.10.0
        continue-on-error: true
        with:
          target: "http://localhost:3000"
          fail_action: "ignore"        # IMPORTANT : ne jamais échouer le job
          artifact_name: "zap-reports"
          cmd_options: >
            -t http://localhost:3000
            -r report_html.html
            -J report_json.json
            -w report_md.md

      - name: Show ZAP text report in logs
        if: always()
        run: |
          echo "===== DÉBUT DU RAPPORT TEXTE ZAP (report_md.md) ====="
          if [ -f report_md.md ]; then
            sed -n '1,400p' report_md.md || true
          else
            echo "Fichier report_md.md introuvable."
          fi
          echo "===== FIN DU RAPPORT TEXTE ZAP ====="

      - name: Analyze JSON report and print Vulnerability detected / No Vulnerability detected
        if: always()
        run: |
          echo "Analyse de report_json.json..."
          ALERTS_COUNT=0

          if [ -f report_json.json ]; then
            echo "Fichier report_json.json trouvé, tentative de parse avec jq..."
            # On compte le nombre total d'alertes (toutes severities confondues)
            COUNT=$(jq '[..|.alerts? // empty] | map(length) | add // 0' report_json.json 2>/dev/null || echo "0")

            # Si jq renvoie un nombre valide, on l'utilise
            if echo "$COUNT" | grep -E '^[0-9]+$' >/dev/null 2>&1; then
              ALERTS_COUNT="$COUNT"
            else
              # Fallback ultra simple : compter les occurrences du mot "alert"
              ALERTS_COUNT=$(grep -o '"alert":' -c report_json.json || echo "0")
            fi
          else
            echo "report_json.json introuvable -> on suppose 0 alerte."
          fi

          echo "Nombre d'alertes estimé : $ALERTS_COUNT"

          if [ "$ALERTS_COUNT" -gt 0 ]; then
            echo "==============================="
            echo "Vulnerability detected"
            echo "Total alerts (approx) : $ALERTS_COUNT"
            echo "==============================="
          else
            echo "==============================="
            echo "No Vulnerability detected"
            echo "==============================="
          fi

          # Très important : ne jamais faire exit 1, quel que soit le résultat
          exit 0

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_html.html
            report_json.json
            report_md.md

      - name: Teardown
        if: always()
        run: |
          # Stopper le conteneur docker si présent
          if docker ps -a --format '{{.Names}}' | grep -q '^dast-lab-app$'; then
            docker rm -f dast-lab-app || true
          fi

          # Stopper le serveur python s'il a été lancé (best effort)
          if pgrep -f "python3 -m http.server 3000" >/dev/null 2>&1; then
            pkill -f "python3 -m http.server 3000" || true
          fi
